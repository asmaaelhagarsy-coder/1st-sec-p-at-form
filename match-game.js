import { speak } from './tts.js';
function shuffleNonAdjacentPairs(pairs){const cards=[];pairs.forEach((p,i)=>{cards.push({type:'word',text:p.word,pair:i});cards.push({type:'meaning',text:p.meaning,pair:i});});function isValid(arr){for(let i=0;i<arr.length-1;i++){if(arr[i].pair===arr[i+1].pair&&arr[i].type!==arr[i+1].type)return false;}return true;}let tries=0;do{cards.sort(()=>Math.random()-0.5);tries++;if(tries>2000)break;}while(!isValid(cards));return cards}
export function initMatchGame(root){const container=root.querySelector('#match-game');if(!container)return;let data=[];const jsonEl=container.querySelector('script[type="application/json"]');if(jsonEl)data=JSON.parse(jsonEl.textContent);if(!data.length){container.innerHTML='<div class="card">No pairs provided.</div>';return;}function render(cards){container.innerHTML=`<div class="controls" style="display:flex;gap:8px;margin-bottom:10px"><button id="retry">Retry</button></div><div class="grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px"></div><audio id="sfxOk" src="assets/audio/sfx-correct.mp3" preload="auto"></audio>`;const grid=container.querySelector('.grid');const sfxOk=container.querySelector('#sfxOk');let first=null,lock=false,solved=0;cards.forEach((c)=>{const card=document.createElement('button');card.className='card';card.textContent=c.text;card.dataset.pair=c.pair;card.dataset.type=c.type;card.disabled=false;card.style.transition='transform .2s';card.addEventListener('click',()=>{if(lock||card.disabled)return;card.classList.add('active');card.style.transform='scale(1.03)';if(!first){first=card;return;}if(first===card)return;lock=true;const match=(first.dataset.pair===card.dataset.pair)&&(first.dataset.type!==card.dataset.type);if(match){[first,card].forEach(el=>{el.style.outline='2px solid var(--accent)';el.style.transform='scale(1.05)';});const wordBtn=[first,card].find(x=>x.dataset.type==='word');if(wordBtn)speak(wordBtn.textContent);sfxOk.currentTime=0;sfxOk.play().catch(()=>{});setTimeout(()=>{first.disabled=true;card.disabled=true;first.style.opacity=.6;card.style.opacity=.6;solved+=2;first=null;lock=false;if(solved===cards.length){const done=document.createElement('div');done.className='card';done.textContent='Great job! All matched.';container.appendChild(done);} },300);}else{setTimeout(()=>{first.classList.remove('active');first.style.transform='scale(1)';card.classList.remove('active');card.style.transform='scale(1)';first=null;lock=false;},350);} });grid.appendChild(card);});container.querySelector('#retry').addEventListener('click',()=>{const newCards=shuffleNonAdjacentPairs(data);render(newCards);});}
render(shuffleNonAdjacentPairs(data));}
